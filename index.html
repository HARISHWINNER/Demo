<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificate QR Authenticator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- New SVG QR Code Generation Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-svg@1.1.0/dist/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Playfair+Display:wght@900&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- High-Quality Print Styles --- */
        @page {
            size: A4 landscape;
            margin: 0;
        }

        @media print {
            html, body {
                width: 297mm;
                height: 210mm;
                margin: 0;
                padding: 0;
            }
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .no-print { display: none !important; }
            #certificate-preview {
                display: block !important;
                position: absolute;
                top: 0; left: 0;
                width: 100%; height: 100%;
                margin: 0;
                padding: 1cm;
                border: none; /* Border is now part of the inner div */
                box-sizing: border-box;
            }
            .certificate-font { text-rendering: geometricPrecision; }
            #qrcode-preview svg { shape-rendering: crispEdges; }
        }
        /* --- End Print Styles --- */

        body {
            background-color: #f8fafc;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d4d4d8' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .certificate-font { font-family: 'Merriweather', serif; }
        .cert-title-font { font-family: 'Playfair Display', serif; }
        .ui-font { font-family: 'Lato', sans-serif; }
        .certificate-background {
            background-color: #fdfdfd;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%23e5e7eb' fill-opacity='0.4'%3E%3Cpath opacity='.5' d='M96 95h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9zm-1 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9z'/%3E%3Cpath d='M6 5V0H5v5H0v1h5v94h1V6h94V5H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
    </style>
</head>
<body class="ui-font antialiased">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Generator View -->
        <div id="generator-view">
            <header class="text-center mb-8 no-print">
                <!-- THIS HEADER TEXT WAS CHANGED TO FORCE A CACHE REFRESH -->
                <h1 class="text-4xl sm:text-5xl font-bold text-gray-800 cert-title-font">Certificate Generator & Authenticator</h1>
                <p class="text-gray-600 mt-2 text-lg">Generate and preview a verifiable certificate.</p>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                <!-- Input Form -->
                <div class="bg-white p-6 rounded-xl shadow-lg no-print">
                    <h2 class="text-2xl font-bold text-gray-700 border-b pb-3 mb-6">1. Enter Certificate Details</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="certName" class="block text-sm font-medium text-gray-700">Recipient Name</label>
                            <input type="text" id="certName" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Ada Lovelace">
                        </div>
                        <div>
                            <label for="certCourse" class="block text-sm font-medium text-gray-700">Course / Achievement</label>
                            <select id="certCourse" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                        <div>
                            <label for="certDesc" class="block text-sm font-medium text-gray-700">Course Description</label>
                            <textarea id="certDesc" rows="3" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm" readonly placeholder="Select a course to see its description."></textarea>
                        </div>
                        <div>
                            <label for="certDate" class="block text-sm font-medium text-gray-700">Date of Issue</label>
                            <input type="text" id="certDate" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm" readonly>
                        </div>
                    </div>
                    <button id="generateBtn" class="mt-8 w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:from-indigo-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105 duration-150 ease-in-out">
                        Generate & Preview Certificate
                    </button>
                </div>

                <!-- Certificate Preview -->
                <div id="certificate-preview-container" class="hidden">
                     <h2 class="text-2xl font-bold text-gray-700 text-center lg:text-left mb-4 no-print">2. Preview & Print</h2>
                    <div id="certificate-preview" class="bg-white p-4 rounded-lg shadow-2xl border border-gray-200 aspect-[1/1.414] relative">
                        <div class="w-full h-full p-2 border-2 border-gray-600">
                            <div class="w-full h-full text-center border-4 border-amber-400 p-6 flex flex-col certificate-background">
                                <div class="flex-shrink-0">
                                    <p class="certificate-font text-2xl text-gray-600">Certificate of Achievement</p>
                                    <div class="w-24 h-1 bg-amber-400 mx-auto mt-2 mb-4"></div>
                                    <p class="certificate-font text-lg mt-4 text-gray-500">This certificate is proudly presented to</p>
                                </div>
                                <div class="flex-grow flex items-center justify-center">
                                    <div class="text-center">
                                        <p id="preview-name" class="cert-title-font font-bold my-4 text-indigo-700"></p>
                                        <p class="certificate-font text-base text-gray-500">for successfully completing the course</p>
                                        <p id="preview-course-title" class="certificate-font text-2xl font-semibold mt-2 text-gray-800"></p>
                                        <p id="preview-course-desc" class="certificate-font text-sm mt-2 text-gray-500 max-w-md mx-auto"></p>
                                    </div>
                                </div>
                                <div class="flex-shrink-0 w-full grid grid-cols-3 items-end text-sm mt-8">
                                    <div class="text-center">
                                        <p id="preview-date" class="border-b-2 border-gray-400 pb-1"></p>
                                        <p class="font-bold pt-1">Date Issued</p>
                                    </div>
                                    <div id="qrcode-preview" class="w-24 h-24 p-1 border bg-white rounded-md shadow-sm mx-auto"></div>
                                    <div class="text-center">
                                        <p class="border-b-2 border-gray-400 pb-1 h-6"></p>
                                        <p class="font-bold pt-1">Issuing Authority</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                     <button id="printBtn" class="mt-6 w-full bg-gray-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-transform transform hover:scale-105 duration-150 ease-in-out no-print">
                        Print Certificate
                    </button>
                </div>
            </div>
        </div>

        <!-- Validation View -->
        <div id="validation-view" class="hidden">
             <header class="text-center mb-8">
                <h1 class="text-4xl sm:text-5xl font-bold text-gray-800 cert-title-font">Certificate Validation</h1>
            </header>
            <div class="max-w-4xl mx-auto">
                <!-- Validation Certificate Display -->
                <div id="validation-certificate-display" class="bg-white p-4 rounded-lg shadow-2xl border border-gray-200 aspect-[1/1.414] relative">
                    <div id="validation-badge" class="absolute top-6 right-6 text-white font-bold py-2 px-4 rounded-lg text-lg hidden shadow-lg"></div>
                     <div class="w-full h-full p-2 border-2 border-gray-600">
                        <div class="w-full h-full text-center border-4 border-amber-400 p-6 flex flex-col certificate-background">
                            <div class="flex-shrink-0">
                                <p class="certificate-font text-2xl text-gray-600">Certificate of Achievement</p>
                                <div class="w-24 h-1 bg-amber-400 mx-auto mt-2 mb-4"></div>
                                <p class="certificate-font text-lg mt-4 text-gray-500">This certificate is proudly presented to</p>
                            </div>
                            <div class="flex-grow flex items-center justify-center">
                                <div class="text-center">
                                    <p id="validation-name" class="cert-title-font font-bold my-4 text-indigo-700"></p>
                                    <p class="certificate-font text-base text-gray-500">for successfully completing the course</p>
                                    <p id="validation-course-title" class="certificate-font text-2xl font-semibold mt-2 text-gray-800"></p>
                                    <p id="validation-course-desc" class="certificate-font text-sm mt-2 text-gray-500 max-w-md mx-auto"></p>
                                </div>
                            </div>
                            <div class="flex-shrink-0 w-full grid grid-cols-2 items-end text-sm mt-8">
                                <div class="text-center">
                                    <p id="validation-date" class="border-b-2 border-gray-400 pb-1"></p>
                                    <p class="font-bold pt-1">Date Issued</p>
                                </div>
                                <div class="text-center">
                                    <p class="border-b-2 border-gray-400 pb-1 h-6"></p>
                                    <p class="font-bold pt-1">Issuing Authority</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- IMPORTANT: This is now the single source of truth for security ---
        // You can change this to any unique, complex string you want.
        const SECRET_KEY = "Your-Own-Unique-And-Hard-To-Guess-Secret-Key-Goes-Here";

        // --- Simulated Database ---
        const coursesDB = [ 
            { id: 101, title: 'Advanced Web Development', description: 'For demonstrating mastery in modern web development principles and practices.' }, 
            { id: 102, title: 'Introduction to AI', description: 'For completing the foundational course on Artificial Intelligence and Machine Learning.' }, 
            { id: 103, title: 'Cybersecurity Essentials', description: 'For acquiring essential skills in protecting digital assets and infrastructure.' }, 
            { id: 104, title: 'Data Structures & Algorithms', description: 'For mastering fundamental concepts of data organization and problem-solving.' },
            { id: 105, title: 'Cloud Computing Foundations', description: 'For understanding the core concepts of cloud services and architecture.' },
            { id: 106, title: 'Project Management Professional (PMP)', description: 'For achieving a globally recognized standard in project management.' },
            { id: 107, title: 'Digital Marketing Fundamentals', description: 'For acquiring key skills in online marketing, SEO, and social media strategy.' },
            { id: 108, title: 'UX/UI Design Principles', description: 'For mastering the art and science of creating user-centered digital experiences.' }
        ];

        // --- Core Cryptography ---
        async function createSignature(text, secret) {
            const data = new TextEncoder().encode(secret + text);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        // --- Page Load Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const hash = window.location.hash;
            if (hash.startsWith('#validate?cert=')) {
                document.getElementById('generator-view').classList.add('hidden');
                document.getElementById('validation-view').classList.remove('hidden');
                handleValidationFromURL();
            } else {
                document.getElementById('generator-view').classList.remove('hidden');
                document.getElementById('validation-view').classList.add('hidden');
                populateCourseDropdown();
                setAutonomousDate();
            }
        });

        // --- Helper function to adjust font size based on name length ---
        function adjustNameFontSize(element, name) {
            element.textContent = name;
            // Reset classes to a base state
            element.className = 'cert-title-font font-bold my-4 text-indigo-700';
            
            if (name.length > 25) {
                element.classList.add('text-3xl');
            } else if (name.length > 15) {
                element.classList.add('text-4xl');
            } else {
                element.classList.add('text-5xl');
            }
        }

        // --- Generator View Logic ---
        function populateCourseDropdown() {
            const certCourseSelect = document.getElementById('certCourse');
            coursesDB.forEach(course => {
                const option = document.createElement('option');
                option.value = course.id;
                option.textContent = course.title;
                certCourseSelect.appendChild(option);
            });
            certCourseSelect.addEventListener('change', () => {
                const selectedCourseId = parseInt(certCourseSelect.value);
                const selectedCourse = coursesDB.find(c => c.id === selectedCourseId);
                document.getElementById('certDesc').value = selectedCourse ? selectedCourse.description : '';
            });
            certCourseSelect.dispatchEvent(new Event('change'));
        }

        function setAutonomousDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('certDate').value = `${year}-${month}-${day}`;
        }

        document.getElementById('generateBtn').addEventListener('click', async () => {
            const name = document.getElementById('certName').value.trim();
            const selectedCourseId = parseInt(document.getElementById('certCourse').value);
            const course = coursesDB.find(c => c.id === selectedCourseId);
            const description = document.getElementById('certDesc').value;
            const date = document.getElementById('certDate').value;
            
            if (!name || !course || !date) {
                alert('Please fill in all required fields.');
                return;
            }

            const previewNameEl = document.getElementById('preview-name');
            adjustNameFontSize(previewNameEl, name);

            document.getElementById('preview-course-title').textContent = course.title;
            document.getElementById('preview-course-desc').textContent = description;
            document.getElementById('preview-date').textContent = date;

            const certificateData = { name, course: course.title, description, date };
            const dataString = JSON.stringify(certificateData);
            const signature = await createSignature(dataString, SECRET_KEY); // Use the constant key
            const qrPayload = { data: certificateData, sig: signature };
            const encodedPayload = btoa(JSON.stringify(qrPayload));
            const validationUrl = `${window.location.href.split('#')[0]}#validate?cert=${encodedPayload}`;

            const qrcodePreviewDiv = document.getElementById('qrcode-preview');
            qrcodePreviewDiv.innerHTML = new QRCode({
                content: validationUrl,
                padding: 0,
                width: 96,
                height: 96,
                ecl: "H",
                shape: "rounded" // This creates the rounded shape
            }).svg();
            document.getElementById('certificate-preview-container').classList.remove('hidden');
        });

        document.getElementById('printBtn').addEventListener('click', () => {
            const courseName = document.getElementById('preview-course-title').textContent;
            const recipientName = document.getElementById('preview-name').textContent;
            const originalTitle = document.title;

            if (courseName && recipientName) {
                // Create a clean filename like "Certificate_Advanced_Web_Development_Ada_Lovelace"
                const cleanCourseName = courseName.replace(/[^a-zA-Z0-9]/g, '_');
                const cleanRecipientName = recipientName.replace(/[^a-zA-Z0-9]/g, '_');
                document.title = `Certificate_${cleanCourseName}_${cleanRecipientName}`;
            }

            window.print();

            // Restore the original title after the print dialog is handled.
            setTimeout(() => {
                document.title = originalTitle;
            }, 1000);
        });

        // --- Validation View Logic ---
        async function handleValidationFromURL() {
            try {
                const encodedPayload = window.location.hash.split('cert=')[1];
                if (!encodedPayload) throw new Error("Certificate data not found in URL.");

                const payload = JSON.parse(atob(encodedPayload));
                if (!payload.data || !payload.sig) throw new Error("Invalid certificate data format.");
                
                // Populate the visual certificate
                const validationNameEl = document.getElementById('validation-name');
                adjustNameFontSize(validationNameEl, payload.data.name);

                document.getElementById('validation-course-title').textContent = payload.data.course;
                document.getElementById('validation-course-desc').textContent = payload.data.description;
                document.getElementById('validation-date').textContent = payload.data.date;
                
                // Automatically verify the certificate
                const dataString = JSON.stringify(payload.data);
                const expectedSignature = await createSignature(dataString, SECRET_KEY); // Use the constant key

                if (payload.sig === expectedSignature) {
                    displayValidationResult(true);
                } else {
                    displayValidationResult(false);
                }

            } catch (error) {
                console.error(error);
                document.getElementById('validation-certificate-display').innerHTML = `<p class="text-red-500 text-center text-xl p-8">Error: Could not read certificate data from the URL. It may be corrupted or invalid.</p>`;
            }
        }

        function displayValidationResult(isValid) {
            const validationBadge = document.getElementById('validation-badge');
            validationBadge.classList.remove('hidden', 'bg-green-600', 'bg-red-600');
            
            if (isValid) {
                validationBadge.textContent = 'AUTHENTIC';
                validationBadge.classList.add('bg-green-600');
            } else {
                validationBadge.textContent = 'INVALID';
                validationBadge.classList.add('bg-red-600');
            }
        }
    </script>
</body>
</html>
