<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificate QR Authenticator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- New SVG QR Code Generation Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-svg@1.1.0/dist/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Playfair+Display:wght@900&display=swap" rel="stylesheet">
    <style>
        /* --- High-Quality Print Styles --- */
        @page {
            size: A4 landscape;
            margin: 0;
        }

        @media print {
            html, body {
                width: 297mm;
                height: 210mm;
                margin: 0;
                padding: 0;
            }
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .no-print { display: none !important; }
            #certificate-preview {
                display: block !important;
                position: absolute;
                top: 0; left: 0;
                width: 100%; height: 100%;
                margin: 0;
                padding: 1cm;
                border: 10px solid #374151;
                box-sizing: border-box;
            }
            .certificate-font { text-rendering: geometricPrecision; }
            #qrcode-preview svg { shape-rendering: crispEdges; }
        }
        /* --- End Print Styles --- */

        .certificate-font { font-family: 'Merriweather', serif; }
        .cert-title-font { font-family: 'Playfair Display', serif; }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Generator View -->
        <div id="generator-view">
            <header class="text-center mb-8 no-print">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Certificate QR Authenticator</h1>
                <p class="text-gray-600 mt-2">Generate and preview a verifiable certificate.</p>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                <!-- Input Form -->
                <div class="bg-white p-6 rounded-lg shadow-md no-print">
                    <h2 class="text-2xl font-semibold text-gray-700 border-b pb-3 mb-4">1. Enter Certificate Details</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="certName" class="block text-sm font-medium text-gray-700">Recipient Name</label>
                            <input type="text" id="certName" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Ada Lovelace">
                        </div>
                        <div>
                            <label for="certCourse" class="block text-sm font-medium text-gray-700">Course / Achievement</label>
                            <select id="certCourse" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                        <div>
                            <label for="certDesc" class="block text-sm font-medium text-gray-700">Course Description</label>
                            <textarea id="certDesc" rows="2" class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm" readonly placeholder="Select a course to see its description."></textarea>
                        </div>
                        <div>
                            <label for="certDate" class="block text-sm font-medium text-gray-700">Date of Issue</label>
                            <input type="text" id="certDate" class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm" readonly>
                        </div>
                    </div>
                    <button id="generateBtn" class="mt-6 w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                        Generate & Preview Certificate
                    </button>
                </div>

                <!-- Certificate Preview -->
                <div id="certificate-preview-container" class="hidden">
                     <h2 class="text-2xl font-semibold text-gray-700 text-center lg:text-left mb-4 no-print">2. Preview & Print</h2>
                    <div id="certificate-preview" class="bg-white p-8 rounded-lg shadow-2xl border-4 border-gray-300 aspect-[1.414/1] relative">
                        <div class="text-center border-2 border-gray-800 p-6 h-full flex flex-col">
                            <div class="flex-shrink-0">
                                <h1 class="cert-title-font text-4xl sm:text-5xl font-black text-gray-800">Certificate of Completion</h1>
                                <p class="certificate-font text-lg mt-4">This certificate is proudly presented to</p>
                            </div>
                            <div class="flex-grow flex items-center justify-center">
                                <div class="text-center">
                                    <p id="preview-name" class="certificate-font text-3xl sm:text-4xl font-bold my-4 text-indigo-700"></p>
                                    <p class="certificate-font text-lg">for successfully completing the course</p>
                                    <p id="preview-course-title" class="certificate-font text-2xl font-semibold mt-2"></p>
                                    <p id="preview-course-desc" class="certificate-font text-sm mt-1 text-gray-600"></p>
                                </div>
                            </div>
                            <div class="flex-shrink-0 w-full flex justify-between items-end text-sm">
                                <div class="text-left">
                                    <p class="font-bold border-t-2 border-gray-700 pt-1">Date Issued</p>
                                    <p id="preview-date"></p>
                                </div>
                                <div id="qrcode-preview" class="w-24 h-24 p-1 border bg-white"></div>
                                <div class="text-right">
                                    <p class="font-bold border-t-2 border-gray-700 pt-1">Signature</p>
                                    <p>Issuing Authority</p>
                                </div>
                            </div>
                        </div>
                    </div>
                     <button id="printBtn" class="mt-6 w-full bg-gray-700 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-150 ease-in-out no-print">
                        Print Certificate
                    </button>
                </div>
            </div>
        </div>

        <!-- Validation View -->
        <div id="validation-view" class="hidden">
             <header class="text-center mb-8">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Certificate Validation</h1>
            </header>
            <div class="max-w-4xl mx-auto">
                <!-- Validation Certificate Display -->
                <div id="validation-certificate-display" class="bg-white p-8 rounded-lg shadow-2xl border-4 border-gray-300 aspect-[1.414/1] relative">
                    <div id="validation-badge" class="absolute top-4 right-4 text-white font-bold py-2 px-4 rounded-lg text-lg hidden"></div>
                    <div class="text-center border-2 border-gray-800 p-6 h-full flex flex-col">
                        <div class="flex-shrink-0">
                            <h1 class="cert-title-font text-4xl sm:text-5xl font-black text-gray-800">Certificate of Completion</h1>
                            <p class="certificate-font text-lg mt-4">This certificate is proudly presented to</p>
                        </div>
                        <div class="flex-grow flex items-center justify-center">
                            <div class="text-center">
                                <p id="validation-name" class="certificate-font text-3xl sm:text-4xl font-bold my-4 text-indigo-700"></p>
                                <p class="certificate-font text-lg">for successfully completing the course</p>
                                <p id="validation-course-title" class="certificate-font text-2xl font-semibold mt-2"></p>
                                <p id="validation-course-desc" class="certificate-font text-sm mt-1 text-gray-600"></p>
                            </div>
                        </div>
                        <div class="flex-shrink-0 w-full flex justify-between items-end text-sm">
                            <div class="text-left">
                                <p class="font-bold border-t-2 border-gray-700 pt-1">Date Issued</p>
                                <p id="validation-date"></p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold border-t-2 border-gray-700 pt-1">Signature</p>
                                <p>Issuing Authority</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- IMPORTANT: This is now the single source of truth for security ---
        // You can change this to any unique, complex string you want.
        const SECRET_KEY = "Your-Own-Unique-And-Hard-To-Guess-Secret-Key-Goes-Here";

        // --- Simulated Database ---
        const coursesDB = [ 
            { id: 101, title: 'Advanced Web Development', description: 'For demonstrating mastery in modern web development principles and practices.' }, 
            { id: 102, title: 'Introduction to AI', description: 'For completing the foundational course on Artificial Intelligence and Machine Learning.' }, 
            { id: 103, title: 'Cybersecurity Essentials', description: 'For acquiring essential skills in protecting digital assets and infrastructure.' }, 
            { id: 104, title: 'Data Structures & Algorithms', description: 'For mastering fundamental concepts of data organization and problem-solving.' },
            { id: 105, title: 'Cloud Computing Foundations', description: 'For understanding the core concepts of cloud services and architecture.' },
            { id: 106, title: 'Project Management Professional (PMP)', description: 'For achieving a globally recognized standard in project management.' },
            { id: 107, title: 'Digital Marketing Fundamentals', description: 'For acquiring key skills in online marketing, SEO, and social media strategy.' },
            { id: 108, title: 'UX/UI Design Principles', description: 'For mastering the art and science of creating user-centered digital experiences.' }
        ];

        // --- Core Cryptography ---
        async function createSignature(text, secret) {
            const data = new TextEncoder().encode(secret + text);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        // --- Page Load Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const hash = window.location.hash;
            if (hash.startsWith('#validate?cert=')) {
                document.getElementById('generator-view').classList.add('hidden');
                document.getElementById('validation-view').classList.remove('hidden');
                handleValidationFromURL();
            } else {
                document.getElementById('generator-view').classList.remove('hidden');
                document.getElementById('validation-view').classList.add('hidden');
                populateCourseDropdown();
                setAutonomousDate();
            }
        });

        // --- Generator View Logic ---
        function populateCourseDropdown() {
            const certCourseSelect = document.getElementById('certCourse');
            coursesDB.forEach(course => {
                const option = document.createElement('option');
                option.value = course.id;
                option.textContent = course.title;
                certCourseSelect.appendChild(option);
            });
            certCourseSelect.addEventListener('change', () => {
                const selectedCourseId = parseInt(certCourseSelect.value);
                const selectedCourse = coursesDB.find(c => c.id === selectedCourseId);
                document.getElementById('certDesc').value = selectedCourse ? selectedCourse.description : '';
            });
            certCourseSelect.dispatchEvent(new Event('change'));
        }

        function setAutonomousDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('certDate').value = `${year}-${month}-${day}`;
        }

        document.getElementById('generateBtn').addEventListener('click', async () => {
            const name = document.getElementById('certName').value.trim();
            const selectedCourseId = parseInt(document.getElementById('certCourse').value);
            const course = coursesDB.find(c => c.id === selectedCourseId);
            const description = document.getElementById('certDesc').value;
            const date = document.getElementById('certDate').value;
            
            if (!name || !course || !date) {
                alert('Please fill in all required fields.');
                return;
            }

            document.getElementById('preview-name').textContent = name;
            document.getElementById('preview-course-title').textContent = course.title;
            document.getElementById('preview-course-desc').textContent = description;
            document.getElementById('preview-date').textContent = date;

            const certificateData = { name, course: course.title, description, date };
            const dataString = JSON.stringify(certificateData);
            const signature = await createSignature(dataString, SECRET_KEY); // Use the constant key
            const qrPayload = { data: certificateData, sig: signature };
            const encodedPayload = btoa(JSON.stringify(qrPayload));
            const validationUrl = `${window.location.href.split('#')[0]}#validate?cert=${encodedPayload}`;

            const qrcodePreviewDiv = document.getElementById('qrcode-preview');
            qrcodePreviewDiv.innerHTML = new QRCode({ content: validationUrl, padding: 0, width: 96, height: 96, ecl: "H" }).svg();
            document.getElementById('certificate-preview-container').classList.remove('hidden');
        });

        document.getElementById('printBtn').addEventListener('click', () => {
            const courseName = document.getElementById('preview-course-title').textContent;
            const recipientName = document.getElementById('preview-name').textContent;
            const originalTitle = document.title;

            if (courseName && recipientName) {
                // Create a clean filename like "Certificate_Advanced_Web_Development_Ada_Lovelace"
                const cleanCourseName = courseName.replace(/[^a-zA-Z0-9]/g, '_');
                const cleanRecipientName = recipientName.replace(/[^a-zA-Z0-9]/g, '_');
                document.title = `Certificate_${cleanCourseName}_${cleanRecipientName}`;
            }

            window.print();

            // Restore the original title after the print dialog is handled.
            setTimeout(() => {
                document.title = originalTitle;
            }, 1000);
        });

        // --- Validation View Logic ---
        async function handleValidationFromURL() {
            try {
                const encodedPayload = window.location.hash.split('cert=')[1];
                if (!encodedPayload) throw new Error("Certificate data not found in URL.");

                const payload = JSON.parse(atob(encodedPayload));
                if (!payload.data || !payload.sig) throw new Error("Invalid certificate data format.");
                
                // Populate the visual certificate
                document.getElementById('validation-name').textContent = payload.data.name;
                document.getElementById('validation-course-title').textContent = payload.data.course;
                document.getElementById('validation-course-desc').textContent = payload.data.description;
                document.getElementById('validation-date').textContent = payload.data.date;
                
                // Automatically verify the certificate
                const dataString = JSON.stringify(payload.data);
                const expectedSignature = await createSignature(dataString, SECRET_KEY); // Use the constant key

                if (payload.sig === expectedSignature) {
                    displayValidationResult(true);
                } else {
                    displayValidationResult(false);
                }

            } catch (error) {
                console.error(error);
                document.getElementById('validation-certificate-display').innerHTML = `<p class="text-red-500 text-center text-xl p-8">Error: Could not read certificate data from the URL. It may be corrupted or invalid.</p>`;
            }
        }

        function displayValidationResult(isValid) {
            const validationBadge = document.getElementById('validation-badge');
            validationBadge.classList.remove('hidden', 'bg-green-600', 'bg-red-600');
            
            if (isValid) {
                validationBadge.textContent = 'AUTHENTIC';
                validationBadge.classList.add('bg-green-600');
            } else {
                validationBadge.textContent = 'INVALID';
                validationBadge.classList.add('bg-red-600');
            }
        }
    </script>
</body>
</html>
