<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificate QR Authenticator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- New SVG QR Code Generation Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-svg@1.1.0/dist/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Playfair+Display:wght@900&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- High-Quality Print Styles --- */
        @page {
            size: A4 landscape;
            margin: 0;
        }

        @media print {
            html, body {
                width: 297mm;
                height: 210mm;
                margin: 0;
                padding: 0;
            }
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .no-print { display: none !important; }
            .printable-certificate {
                display: flex !important;
                position: absolute;
                top: 0; left: 0;
                width: 100%; height: 100%;
                margin: 0;
                padding: 0;
                border: none;
                box-sizing: border-box;
                border-radius: 0;
                box-shadow: none;
            }
            /* Explicitly define panel widths for printing */
            .printable-certificate > .cert-left-panel {
                width: 33.3333% !important;
            }
            .printable-certificate > .cert-right-panel {
                width: 66.6667% !important;
            }
            .certificate-font { text-rendering: geometricPrecision; }
            #qrcode-preview svg { shape-rendering: crispEdges; }
        }
        /* --- End Print Styles --- */

        body {
            background-color: #f8fafc;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d4d4d8' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .certificate-font { font-family: 'Merriweather', serif; }
        .cert-title-font { font-family: 'Playfair Display', serif; }
        .ui-font { font-family: 'Lato', sans-serif; }
    </style>
</head>
<body class="ui-font antialiased">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Generator View -->
        <div id="generator-view">
            <header class="text-center mb-8 no-print">
                <h1 class="text-4xl sm:text-5xl font-bold text-gray-800 cert-title-font">Certificate Generator & Authenticator</h1>
                <p class="text-gray-600 mt-2 text-lg">Generate and preview a verifiable certificate.</p>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                <!-- Input Form -->
                <div class="bg-white p-6 rounded-xl shadow-lg no-print">
                    <h2 class="text-2xl font-bold text-gray-700 border-b pb-3 mb-6">1. Enter Certificate Details</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="certName" class="block text-sm font-medium text-gray-700">Recipient Name</label>
                            <input type="text" id="certName" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Ada Lovelace">
                        </div>
                        <div>
                            <label for="certCourse" class="block text-sm font-medium text-gray-700">Course / Achievement</label>
                            <select id="certCourse" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                        <div>
                            <label for="certDesc" class="block text-sm font-medium text-gray-700">Course Description</label>
                            <textarea id="certDesc" rows="3" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm" readonly placeholder="Select a course to see its description."></textarea>
                        </div>
                        <div>
                            <label for="certDate" class="block text-sm font-medium text-gray-700">Date of Issue</label>
                            <input type="text" id="certDate" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm" readonly>
                        </div>
                    </div>
                    <button id="generateBtn" class="mt-8 w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:from-indigo-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105 duration-150 ease-in-out">
                        Generate & Preview Certificate
                    </button>
                </div>

                <!-- Certificate Preview -->
                <div id="certificate-preview-container" class="hidden">
                     <h2 class="text-2xl font-bold text-gray-700 text-center lg:text-left mb-4 no-print">2. Preview & Print</h2>
                    
                    <!-- Horizontal Preview -->
                    <div id="certificate-preview" class="printable-certificate bg-white rounded-lg shadow-2xl aspect-[1.414/1] relative flex overflow-hidden">
                        <!-- Left Panel -->
                        <div class="w-1/3 bg-gray-800 text-white p-8 flex flex-col justify-between cert-left-panel">
                            <div>
                                <h2 class="cert-title-font text-3xl font-bold">Certificate of Completion</h2>
                                <div class="w-16 h-1 bg-amber-400 mt-4"></div>
                            </div>
                            <div data-cert-field="qrcode" class="w-full p-2 border-2 border-gray-600 bg-white rounded-lg shadow-sm flex items-center justify-center"></div>
                        </div>
                        <!-- Right Panel -->
                        <div class="w-2/3 p-8 flex flex-col cert-right-panel">
                            <div class="flex-grow flex flex-col justify-center text-center">
                                <p class="certificate-font text-lg text-gray-500">This certificate is proudly presented to</p>
                                <p data-cert-field="name" class="cert-title-font font-bold my-2 text-indigo-700"></p>
                                <p class="certificate-font text-base text-gray-500">for successfully completing the course</p>
                                <p data-cert-field="course-title" class="certificate-font text-2xl font-semibold mt-2 text-gray-800"></p>
                                <p data-cert-field="course-desc" class="certificate-font text-sm mt-2 text-gray-500 max-w-md mx-auto"></p>
                            </div>
                            <div class="flex-shrink-0 w-full grid grid-cols-2 items-end text-sm mt-8 gap-8">
                                <div class="text-center">
                                    <p data-cert-field="date" class="border-b-2 border-gray-400 pb-1"></p>
                                    <p class="font-bold pt-1">Date Issued</p>
                                </div>
                                <div class="text-center">
                                    <p class="border-b-2 border-gray-400 pb-1 h-6"></p>
                                    <p class="font-bold pt-1">Issuing Authority</p>
                                </div>
                            </div>
                        </div>
                    </div>

                     <button id="printBtn" class="mt-6 w-full bg-gray-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-transform transform hover:scale-105 duration-150 ease-in-out no-print">
                        Print Certificate
                    </button>
                </div>
            </div>
        </div>

        <!-- Validation View -->
        <div id="validation-view" class="hidden">
             <header class="text-center mb-8">
                <h1 class="text-4xl sm:text-5xl font-bold text-gray-800 cert-title-font">Certificate Validation</h1>
            </header>
            <div class="max-w-4xl mx-auto">
                <!-- Validation Certificate Display -->
                <div id="validation-certificate-display" class="bg-white rounded-lg shadow-2xl aspect-[1.414/1] relative flex overflow-hidden">
                    <div id="validation-badge" class="absolute top-6 right-6 text-white font-bold py-2 px-4 rounded-lg text-lg hidden shadow-lg z-10"></div>
                    <!-- Left Panel -->
                    <div class="w-1/3 bg-gray-800 text-white p-8 flex flex-col justify-between cert-left-panel">
                        <div>
                            <h2 class="cert-title-font text-3xl font-bold">Certificate of Completion</h2>
                            <div class="w-16 h-1 bg-amber-400 mt-4"></div>
                        </div>
                        <div class="text-center">
                             <svg class="w-24 h-24 text-gray-600 mx-auto" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        </div>
                    </div>
                    <!-- Right Panel -->
                    <div class="w-2/3 p-8 flex flex-col cert-right-panel">
                        <div class="flex-grow flex flex-col justify-center text-center">
                            <p class="certificate-font text-lg text-gray-500">This certificate is proudly presented to</p>
                            <p data-cert-field="name" class="cert-title-font font-bold my-2 text-indigo-700"></p>
                            <p class="certificate-font text-base text-gray-500">for successfully completing the course</p>
                            <p data-cert-field="course-title" class="certificate-font text-2xl font-semibold mt-2 text-gray-800"></p>
                            <p data-cert-field="course-desc" class="certificate-font text-sm mt-2 text-gray-500 max-w-md mx-auto"></p>
                        </div>
                        <div class="flex-shrink-0 w-full grid grid-cols-2 items-end text-sm mt-8 gap-8">
                            <div class="text-center">
                                <p data-cert-field="date" class="border-b-2 border-gray-400 pb-1"></p>
                                <p class="font-bold pt-1">Date Issued</p>
                            </div>
                            <div class="text-center">
                                <p class="border-b-2 border-gray-400 pb-1 h-6"></p>
                                <p class="font-bold pt-1">Issuing Authority</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- IMPORTANT: This is now the single source of truth for security ---
        const SECRET_KEY = "Your-Own-Unique-And-Hard-To-Guess-Secret-Key-Goes-Here";

        // --- Simulated Database ---
        const coursesDB = [ 
            { id: 101, title: 'Advanced Web Development', description: 'For demonstrating mastery in modern web development principles and practices.' }, 
            { id: 102, title: 'Introduction to AI', description: 'For completing the foundational course on Artificial Intelligence and Machine Learning.' }, 
            { id: 103, title: 'Cybersecurity Essentials', description: 'For acquiring essential skills in protecting digital assets and infrastructure.' }, 
            { id: 104, title: 'Data Structures & Algorithms', description: 'For mastering fundamental concepts of data organization and problem-solving.' },
            { id: 105, title: 'Cloud Computing Foundations', description: 'For understanding the core concepts of cloud services and architecture.' },
            { id: 106, title: 'Project Management Professional (PMP)', description: 'For achieving a globally recognized standard in project management.' },
            { id: 107, title: 'Digital Marketing Fundamentals', description: 'For acquiring key skills in online marketing, SEO, and social media strategy.' },
            { id: 108, title: 'UX/UI Design Principles', description: 'For mastering the art and science of creating user-centered digital experiences.' }
        ];

        // --- Core Cryptography ---
        async function createSignature(text, secret) {
            const data = new TextEncoder().encode(secret + text);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        // --- Page Load Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const hash = window.location.hash;
            if (hash.startsWith('#validate?cert=')) {
                document.getElementById('generator-view').classList.add('hidden');
                document.getElementById('validation-view').classList.remove('hidden');
                handleValidationFromURL();
            } else {
                document.getElementById('generator-view').classList.remove('hidden');
                document.getElementById('validation-view').classList.add('hidden');
                setupGeneratorView();
            }
        });

        // --- Helper function to adjust font size based on name length ---
        function adjustNameFontSize(element, name) {
            element.textContent = name;
            element.className = element.className.replace(/text-\d?xl/g, ''); // Remove old size classes
            if (name.length > 25) {
                element.classList.add('text-3xl');
            } else if (name.length > 15) {
                element.classList.add('text-4xl');
            } else {
                element.classList.add('text-5xl');
            }
        }

        // --- Generator View Logic ---
        function setupGeneratorView() {
            // Populate Dropdown
            const certCourseSelect = document.getElementById('certCourse');
            coursesDB.forEach(course => {
                const option = document.createElement('option');
                option.value = course.id;
                option.textContent = course.title;
                certCourseSelect.appendChild(option);
            });
            certCourseSelect.addEventListener('change', () => {
                const selectedCourseId = parseInt(certCourseSelect.value);
                const selectedCourse = coursesDB.find(c => c.id === selectedCourseId);
                document.getElementById('certDesc').value = selectedCourse ? selectedCourse.description : '';
            });
            certCourseSelect.dispatchEvent(new Event('change'));

            // Set Date
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('certDate').value = `${year}-${month}-${day}`;

            // Generate Button
            document.getElementById('generateBtn').addEventListener('click', async () => {
                const name = document.getElementById('certName').value.trim();
                const selectedCourseId = parseInt(document.getElementById('certCourse').value);
                const course = coursesDB.find(c => c.id === selectedCourseId);
                const description = document.getElementById('certDesc').value;
                const date = document.getElementById('certDate').value;
                
                if (!name || !course || !date) {
                    alert('Please fill in all required fields.');
                    return;
                }
                
                // Show container first, so we can measure it
                document.getElementById('certificate-preview-container').classList.remove('hidden');
                
                const activePreview = document.getElementById('certificate-preview');

                // Populate the template
                const nameEl = activePreview.querySelector('[data-cert-field="name"]');
                adjustNameFontSize(nameEl, name);
                activePreview.querySelector('[data-cert-field="course-title"]').textContent = course.title;
                activePreview.querySelector('[data-cert-field="course-desc"]').textContent = description;
                activePreview.querySelector('[data-cert-field="date"]').textContent = date;

                const certificateData = { name, course: course.title, description, date };
                const dataString = JSON.stringify(certificateData);
                const signature = await createSignature(dataString, SECRET_KEY);
                const qrPayload = { data: certificateData, sig: signature };
                const encodedPayload = btoa(JSON.stringify(qrPayload));
                const validationUrl = `${window.location.href.split('#')[0]}#validate?cert=${encodedPayload}`;

                const qrcodePreviewDiv = activePreview.querySelector('[data-cert-field="qrcode"]');
                // Use a fixed size for the QR code to avoid measurement issues
                qrcodePreviewDiv.innerHTML = new QRCode({ content: validationUrl, padding: 1, width: 120, height: 120, ecl: "H" }).svg();
            });

            // Print Button
            document.getElementById('printBtn').addEventListener('click', () => {
                const courseName = document.querySelector('#certificate-preview [data-cert-field="course-title"]').textContent;
                const recipientName = document.querySelector('#certificate-preview [data-cert-field="name"]').textContent;
                const originalTitle = document.title;

                if (courseName && recipientName) {
                    const cleanCourseName = courseName.replace(/[^a-zA-Z0-9]/g, '_');
                    const cleanRecipientName = recipientName.replace(/[^a-zA-Z0-9]/g, '_');
                    document.title = `Certificate_${cleanCourseName}_${cleanRecipientName}`;
                }

                window.print();
                
                setTimeout(() => { document.title = originalTitle; }, 1000);
            });
        }

        // --- Validation View Logic ---
        async function handleValidationFromURL() {
            try {
                const encodedPayload = window.location.hash.split('cert=')[1];
                if (!encodedPayload) throw new Error("Certificate data not found in URL.");

                const payload = JSON.parse(atob(encodedPayload));
                if (!payload.data || !payload.sig) throw new Error("Invalid certificate data format.");
                
                const validationCert = document.getElementById('validation-certificate-display');
                
                // Populate the visual certificate
                const validationNameEl = validationCert.querySelector('[data-cert-field="name"]');
                adjustNameFontSize(validationNameEl, payload.data.name);
                validationCert.querySelector('[data-cert-field="course-title"]').textContent = payload.data.course;
                validationCert.querySelector('[data-cert-field="course-desc"]').textContent = payload.data.description;
                validationCert.querySelector('[data-cert-field="date"]').textContent = payload.data.date;
                
                // Automatically verify the certificate
                const dataString = JSON.stringify(payload.data);
                const expectedSignature = await createSignature(dataString, SECRET_KEY);

                displayValidationResult(payload.sig === expectedSignature);

            } catch (error) {
                console.error(error);
                document.getElementById('validation-certificate-display').innerHTML = `<p class="text-red-500 text-center text-xl p-8">Error: Could not read certificate data from the URL. It may be corrupted or invalid.</p>`;
            }
        }

        function displayValidationResult(isValid) {
            const validationBadge = document.getElementById('validation-badge');
            validationBadge.classList.remove('hidden', 'bg-green-600', 'bg-red-600');
            
            if (isValid) {
                validationBadge.textContent = 'AUTHENTIC';
                validationBadge.classList.add('bg-green-600');
            } else {
                validationBadge.textContent = 'INVALID';
                validationBadge.classList.add('bg-red-600');
            }
        }
    </script>
</body>
</html>
